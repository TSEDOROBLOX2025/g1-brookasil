<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>g1 Brookasil - O portal de not√≠cias do RP</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --g1-red: #C4170C;
            --g1-dark: #a3130a;
            --bg-gray: #f6f6f6;
            --text-main: #111;
            --text-sub: #666;
            --border: #ddd;
            --white: #ffffff;
            --gold: #D4AF37; /* Para o Dono */
            --blue-verify: #2a9df4;
        }

        /* --- RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Open Sans', sans-serif; }
        body { background-color: var(--bg-gray); color: var(--text-main); overflow-x: hidden; }
        button { cursor: pointer; transition: 0.2s; border: none; }
        input, textarea, select { border: 1px solid var(--border); border-radius: 4px; padding: 10px; font-size: 14px; width: 100%; outline-color: var(--g1-red); }

        /* --- ESPECIAL ANO NOVO --- */
        #new-year-banner { display: none; background: linear-gradient(90deg, #1a1a2e, #16213e); color: gold; text-align: center; padding: 10px; font-weight: 800; border-bottom: 2px solid gold; position: relative; overflow: hidden; }
        .firework { position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; animation: explode 2s infinite; opacity: 0; }
        @keyframes explode { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(20); opacity: 0; } }

        /* --- HEADER & NAV --- */
        header { background: var(--g1-red); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; position: sticky; top: 0; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { color: white; font-weight: 800; font-size: 32px; letter-spacing: -2px; text-decoration: none; cursor: pointer; }
        .logo span { font-weight: 400; font-size: 14px; letter-spacing: 0; margin-left: 5px; opacity: 0.8; }
        
        .user-nav { display: flex; align-items: center; gap: 15px; color: white; }
        .user-profile-btn { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.1); padding: 5px 12px; border-radius: 20px; cursor: pointer; }
        .user-profile-btn img { width: 30px; height: 30px; border-radius: 50%; background: white; object-fit: cover; }
        .badge-dono { background: var(--gold); color: black; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }

        .sub-header { background: white; border-bottom: 1px solid var(--border); padding: 8px 5%; display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: var(--text-sub); }
        
        .filter-nav { background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: center; overflow-x: auto; sticky; top: 60px; z-index: 1000; }
        .filter-nav button { background: none; padding: 15px 20px; color: var(--g1-red); font-weight: 800; text-transform: uppercase; font-size: 12px; border-bottom: 3px solid transparent; }
        .filter-nav button.active { border-bottom-color: var(--g1-red); }

        /* --- BUSCA --- */
        .search-container { max-width: 1140px; margin: 15px auto 0; padding: 0 15px; }
        
        /* --- GRID PRINCIPAL --- */
        .container { max-width: 1140px; margin: 20px auto; padding: 0 15px; display: grid; grid-template-columns: 1fr 300px; gap: 30px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .sidebar { display: none; } }

        /* --- CARDS DE NOT√çCIAS --- */
        .news-card { background: white; border-bottom: 1px solid #eee; padding-bottom: 25px; margin-bottom: 25px; transition: 0.3s; }
        .news-card.pinned { border: 2px solid var(--g1-red); padding: 15px; border-radius: 8px; }
        .news-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; margin-bottom: 15px; cursor: pointer; }
        .news-cat { color: var(--g1-red); font-weight: 800; font-size: 11px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .news-title { font-size: 26px; font-weight: 800; line-height: 1.2; cursor: pointer; color: var(--text-main); margin-bottom: 8px; }
        .news-title:hover { color: var(--g1-red); }
        .news-sub { color: var(--text-sub); font-size: 16px; margin-bottom: 10px; }
        .news-meta { font-size: 11px; color: #999; display: flex; gap: 10px; align-items: center; }
        .badge-newyear { background: gold; color: black; font-weight: 800; padding: 2px 5px; border-radius: 3px; font-size: 9px; }

        /* --- SIDEBAR --- */
        .box { background: white; padding: 20px; border-top: 3px solid var(--g1-red); margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .box h3 { font-size: 14px; font-weight: 800; margin-bottom: 15px; text-transform: uppercase; color: var(--text-sub); }
        .trending-item { display: flex; gap: 10px; margin-bottom: 15px; cursor: pointer; }
        .trending-rank { color: #ccc; font-size: 24px; font-weight: 800; }
        .trending-text { font-size: 14px; font-weight: 700; line-height: 1.3; }

        /* --- TELAS DE AUTH --- */
        .auth-screen { display: none; max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .auth-screen h2 { text-align: center; margin-bottom: 25px; color: var(--g1-red); }
        .btn-full { width: 100%; background: var(--g1-red); color: white; padding: 12px; font-weight: 800; margin-top: 15px; border-radius: 4px; }
        .btn-secondary { width: 100%; background: #eee; color: #333; padding: 10px; font-weight: 700; margin-top: 10px; border-radius: 4px; }

        /* --- MODAL LEITURA --- */
        #modal-view { position: fixed; inset: 0; background: white; z-index: 4000; display: none; overflow-y: auto; padding-top: 60px; }
        .modal-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .article-content { font-size: 19px; line-height: 1.8; color: #333; margin-top: 25px; }

        /* --- TOAST --- */
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 30px; border-radius: 30px; z-index: 5000; display: none; font-weight: 600; }

        /* --- DARK MODE --- */
        body.dark { background: #121212; color: #eee; }
        body.dark .box, body.dark .news-card, body.dark #modal-view, body.dark .filter-nav, body.dark .sub-header { background: #1e1e1e; color: #eee; border-color: #333; }
        body.dark .news-title { color: #fff; }
        body.dark input, body.dark textarea { background: #2a2a2a; border-color: #444; color: white; }
    </style>
</head>
<body>

    <div id="new-year-banner">
        ‚ú® ESPECIAL DE ANO NOVO g1 BROOKASIL ‚ú®
        <div id="countdown" style="font-size: 12px; margin-top: 5px;"></div>
        <div class="firework" style="left:10%; top:20%"></div>
        <div class="firework" style="right:10%; top:40%"></div>
    </div>

    <div id="toast"></div>

    <header>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="color:white; font-size:24px; cursor:pointer;" onclick="toggleMenu()">‚ò∞</div>
            <a class="logo" onclick="showSection('home')">g1<span>Brookasil</span></a>
        </div>
        
        <div class="user-nav">
            <button onclick="toggleDarkMode()" style="background:none; color:white; font-size:20px;">üåì</button>
            <div id="logged-user" class="user-profile-btn" onclick="showSection('profile')">
                <img id="nav-pfp" src="">
                <span id="nav-name">Entrar</span>
                <div id="nav-badge"></div>
            </div>
        </div>
    </header>

    <div class="sub-header">
        <div><span style="color:red; animation: pulse 1s infinite;">‚óè</span> AO VIVO</div>
        <div id="clima-header">‚òÄÔ∏è ENSOLARADO: 28¬∞C</div>
        <div id="relogio">00:00:00</div>
    </div>

    <nav class="filter-nav" id="main-nav">
        <button class="active" onclick="filterBy('Todas')">Todas</button>
        <button onclick="filterBy('Pol√≠tica')">Pol√≠tica</button>
        <button onclick="filterBy('Pol√≠cia')">Pol√≠cia</button>
        <button onclick="filterBy('Educa√ß√£o')">Educa√ß√£o</button>
        <button onclick="filterBy('Esporte')">Esporte</button>
    </nav>

    <div class="search-container">
        <input type="text" id="global-search" placeholder="üîç O que voc√™ est√° procurando?" oninput="handleSearch()">
    </div>

    <main class="container">
        <section id="sec-home">
            <div id="pinned-news"></div>
            <div id="news-feed"></div>
        </section>

        <aside class="sidebar">
            <div class="box">
                <h3>Em alta hoje</h3>
                <div id="trending-feed"></div>
            </div>
            <div class="box" id="admin-sidebar" style="display:none;">
                <h3>Painel Administrativo</h3>
                <button class="btn-full" onclick="showSection('editor')">Publicar Not√≠cia</button>
                <div id="dono-tools" style="display:none;">
                    <button class="btn-secondary" onclick="showSection('dono-panel')">Configura√ß√µes do Dono</button>
                </div>
            </div>
        </aside>

        <section id="sec-auth" class="auth-screen">
            <h2 id="auth-title">Login</h2>
            <div id="auth-fields">
                <input type="text" id="auth-user" placeholder="Nome de Usu√°rio" style="margin-bottom:10px;">
                <input type="password" id="auth-pass" placeholder="Senha">
                <div id="register-only" style="display:none; margin-top:10px;">
                    <input type="text" id="auth-pfp" placeholder="URL da foto de perfil">
                    <p style="font-size:11px; color:#666; margin-top:5px;">Para ser Jornalista, insira a senha padr√£o do g1 ap√≥s criar a conta.</p>
                </div>
                <button class="btn-full" id="btn-auth-action" onclick="handleAuth()">Entrar</button>
                <button class="btn-secondary" id="btn-switch-auth" onclick="switchAuthMode()">N√£o tenho conta</button>
            </div>
        </section>

        <section id="sec-profile" class="auth-screen">
            <h2>Meu Perfil</h2>
            <center><img id="prof-img" style="width:100px; height:100px; border-radius:50%; margin-bottom:15px; object-fit: cover;"></center>
            <p><strong>Nome:</strong> <span id="prof-name"></span></p>
            <p><strong>Cargo:</strong> <span id="prof-role"></span></p>
            <div id="jornalista-upgrade" style="display:none; margin-top:20px;">
                <input type="password" id="jornalista-code" placeholder="C√≥digo de Jornalista">
                <button class="btn-secondary" onclick="upgradeToJornalista()">Virar Jornalista</button>
            </div>
            <button class="btn-full" style="background:#333;" onclick="handleLogout()">Sair da Conta</button>
        </section>

        <section id="sec-editor" class="auth-screen" style="max-width: 800px;">
            <h2 id="editor-title">Nova Not√≠cia</h2>
            <input type="text" id="n-title" placeholder="T√≠tulo da Manchete" style="margin-bottom:10px;">
            <input type="text" id="n-sub" placeholder="Subt√≠tulo">
            <div style="display:flex; gap:10px; margin:10px 0;">
                <select id="n-cat"><option>Pol√≠tica</option><option>Pol√≠cia</option><option>Educa√ß√£o</option><option>Esporte</option></select>
                <input type="text" id="n-img" placeholder="URL da Imagem">
            </div>
            <textarea id="n-body" rows="10" placeholder="Texto da not√≠cia..."></textarea>
            <div id="edit-actions" style="margin-top:15px;">
                <button class="btn-full" onclick="saveNews()">Publicar Agora</button>
            </div>
        </section>

        <section id="sec-dono-panel" class="auth-screen" style="max-width: 600px;">
            <h2>üëë Configura√ß√µes de Elite</h2>
            <div class="box">
                <h3>Clima do Topo</h3>
                <input type="text" id="cfg-clima" placeholder="Ex: ‚õàÔ∏è TEMPESTADE: 22¬∞C">
                <button class="btn-secondary" onclick="updateClima()">Atualizar</button>
            </div>
            <div class="box">
                <h3>Gerenciar Jornalistas</h3>
                <div id="list-users-admin"></div>
            </div>
        </section>
    </main>

    <div id="modal-view">
        <div class="modal-container">
            <button onclick="closeModal()" style="padding:10px; margin-bottom:20px;">‚Üê Voltar</button>
            <div id="modal-data"></div>
            
            <div style="display:flex; gap:20px; padding:20px 0; border-top:1px solid #eee; margin-top:30px;">
                <button onclick="interact('likes')">üëç <span id="view-likes">0</span></button>
                <button onclick="interact('unlikes')">üëé <span id="view-unlikes">0</span></button>
                <button onclick="interact('reposts')">üîÅ <span id="view-reposts">0</span></button>
            </div>

            <div class="box" style="border:none; background:#f9f9f9;">
                <h3>Coment√°rios</h3>
                <div id="comment-list" style="margin-bottom:20px;"></div>
                <div id="comment-form">
                    <input type="text" id="in-comment" placeholder="Escreva um coment√°rio...">
                    <button class="btn-full" onclick="postComment()">Comentar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = { databaseURL: "https://g1-brookasil-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- ESTADO GLOBAL ---
        let userSession = JSON.parse(localStorage.getItem('g1_session')) || null;
        let isRegistering = false;
        let activeNewsId = null;
        let currentFilter = 'Todas';
        let allNews = [];

        // --- CONTA FIXA DO DONO ---
        const DONO_FIXO = {
            name: "Tutu Prot√°sio",
            role: "Dono",
            pass: "172244",
            pfp: "https://i.imgur.com/W29FclX.png" // Placeholder
        };

        // --- INICIALIZA√á√ÉO ---
        function init() {
            checkUserSession();
            loadNews();
            updateClock();
            checkSpecialDate();
            setInterval(updateClock, 1000);

            db.ref('config/clima').on('value', s => {
                document.getElementById('clima-header').innerText = s.val() || "‚òÄÔ∏è ENSOLARADO: 28¬∞C";
            });
        }

        // --- SISTEMA DE NAVEGA√á√ÉO ---
        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
            document.getElementById('sec-' + id).style.display = 'block';
            window.scrollTo(0,0);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- AUTH & SEGURAN√áA ---
        function checkUserSession() {
            if (userSession) {
                document.getElementById('nav-name').innerText = userSession.name;
                document.getElementById('nav-pfp').src = userSession.pfp || "https://www.w3schools.com/howto/img_avatar.png";
                
                let badge = "";
                if(userSession.role === 'Dono') badge = '<span class="badge-dono">üëë Dono</span>';
                else if(userSession.role === 'Jornalista') badge = '<span class="badge-dono" style="background:#2a9df4; color:white;">‚úçÔ∏è Jornalista</span>';
                document.getElementById('nav-badge').innerHTML = badge;

                // Sidebar Admin
                if(userSession.role === 'Dono' || userSession.role === 'Jornalista') {
                    document.getElementById('admin-sidebar').style.display = 'block';
                    if(userSession.role === 'Dono') document.getElementById('dono-tools').style.display = 'block';
                }

                // Profile Page
                document.getElementById('prof-name').innerText = userSession.name;
                document.getElementById('prof-role').innerText = userSession.role;
                document.getElementById('prof-img').src = userSession.pfp || "https://www.w3schools.com/howto/img_avatar.png";
                
                if(userSession.role === 'Leitor') {
                    document.getElementById('jornalista-upgrade').style.display = 'block';
                } else {
                    document.getElementById('jornalista-upgrade').style.display = 'none';
                }

            } else {
                document.getElementById('nav-name').innerText = "Entrar";
                document.getElementById('nav-pfp').src = "https://www.w3schools.com/howto/img_avatar.png";
                document.getElementById('nav-badge').innerHTML = "";
                document.getElementById('admin-sidebar').style.display = 'none';
            }
        }

        function handleAuth() {
            const user = escapeHTML(document.getElementById('auth-user').value);
            const pass = document.getElementById('auth-pass').value;
            const pfp = document.getElementById('auth-pfp').value;

            if(!user || !pass) return toast("Preencha todos os campos");

            // L√≥gica Especial Dono
            if (user === DONO_FIXO.name) {
                if(pass === DONO_FIXO.pass) {
                    login(DONO_FIXO.name, DONO_FIXO.role, DONO_FIXO.pfp);
                } else {
                    toast("Senha incorreta para o Dono");
                }
                return;
            }

            if (isRegistering) {
                db.ref('users/' + user).once('value', s => {
                    if(s.exists()) return toast("Usu√°rio j√° existe");
                    const userData = { name: user, pass: pass, pfp: pfp, role: 'Leitor' };
                    db.ref('users/' + user).set(userData).then(() => {
                        login(user, 'Leitor', pfp);
                    });
                });
            } else {
                db.ref('users/' + user).once('value', s => {
                    const data = s.val();
                    if(data && data.pass === pass) {
                        login(data.name, data.role, data.pfp);
                    } else {
                        toast("Credenciais inv√°lidas");
                    }
                });
            }
        }

        function login(name, role, pfp) {
            userSession = { name, role, pfp };
            localStorage.setItem('g1_session', JSON.stringify(userSession));
            toast("Bem-vindo, " + name);
            checkUserSession();
            showSection('home');
        }

        function handleLogout() {
            localStorage.removeItem('g1_session');
            userSession = null;
            location.reload();
        }

        function upgradeToJornalista() {
            const code = document.getElementById('jornalista-code').value;
            if(code === "G1_Brookasil") {
                db.ref('users/' + userSession.name + '/role').set('Jornalista').then(() => {
                    userSession.role = 'Jornalista';
                    localStorage.setItem('g1_session', JSON.stringify(userSession));
                    toast("Agora voc√™ √© um Jornalista!");
                    location.reload();
                });
            } else {
                toast("C√≥digo inv√°lido");
            }
        }

        // --- NOT√çCIAS ---
        function loadNews() {
            db.ref('posts').on('value', s => {
                const data = s.val();
                allNews = [];
                if(data) {
                    Object.keys(data).forEach(id => {
                        allNews.push({ id, ...data[id] });
                    });
                }
                renderFeed();
                renderTrending();
            });
        }

        function renderFeed() {
            const feed = document.getElementById('news-feed');
            const pinnedDiv = document.getElementById('pinned-news');
            feed.innerHTML = "";
            pinnedDiv.innerHTML = "";

            let filtered = allNews.filter(n => currentFilter === 'Todas' || n.cat === currentFilter);
            filtered.sort((a,b) => b.timestamp - a.timestamp);

            filtered.forEach(n => {
                const isNewYear = checkNewsSpecial(n.timestamp);
                const html = `
                    <div class="news-card ${n.pinned ? 'pinned' : ''}">
                        ${n.pinned ? '<span class="badge-dono" style="margin-bottom:10px; display:inline-block">üìå FIXADO PELO DONO</span>' : ''}
                        <img src="${n.img}" onclick="openNews('${n.id}')">
                        <span class="news-cat">${n.cat}</span>
                        <h2 class="news-title" onclick="openNews('${n.id}')">${escapeHTML(n.title)}</h2>
                        <p class="news-sub">${escapeHTML(n.sub)}</p>
                        <div class="news-meta">
                            ${isNewYear ? '<span class="badge-newyear">Especial Ano Novo</span>' : ''}
                            <span>Por <strong>${n.author}</strong></span>
                            <span>‚Ä¢ ${n.date}</span>
                            <span>‚Ä¢ üëÅÔ∏è ${n.views || 0}</span>
                        </div>
                        ${canEdit(n) ? `<button onclick="editNews('${n.id}')" style="margin-top:10px; color:blue; background:none;">Editar</button>` : ''}
                        ${canDelete(n) ? `<button onclick="deleteNews('${n.id}')" style="margin-top:10px; color:red; background:none; margin-left:15px;">Excluir</button>` : ''}
                        ${userSession?.role === 'Dono' ? `<button onclick="togglePin('${n.id}', ${n.pinned})" style="margin-top:10px; color:orange; background:none; margin-left:15px;">${n.pinned ? 'Desafixar' : 'Fixar'}</button>` : ''}
                    </div>
                `;

                if(n.pinned && currentFilter === 'Todas') pinnedDiv.innerHTML += html;
                else feed.innerHTML += html;
            });
        }

        function renderTrending() {
            const trend = document.getElementById('trending-feed');
            trend.innerHTML = "";
            const sorted = [...allNews].sort((a,b) => (b.views || 0) - (a.views || 0)).slice(0, 5);
            sorted.forEach((n, i) => {
                trend.innerHTML += `
                    <div class="trending-item" onclick="openNews('${n.id}')">
                        <span class="trending-rank">${i+1}</span>
                        <span class="trending-text">${escapeHTML(n.title)}</span>
                    </div>
                `;
            });
        }

        function saveNews() {
            if(!userSession || (userSession.role !== 'Dono' && userSession.role !== 'Jornalista')) return;

            const title = document.getElementById('n-title').value;
            const sub = document.getElementById('n-sub').value;
            const body = document.getElementById('n-body').value;
            const cat = document.getElementById('n-cat').value;
            const img = document.getElementById('n-img').value;

            if(!title || !body) return toast("T√≠tulo e Corpo s√£o obrigat√≥rios");

            const postData = {
                title, sub, cat, img, 
                text: body,
                author: userSession.name,
                timestamp: activeNewsId ? allNews.find(x=>x.id===activeNewsId).timestamp : Date.now(),
                date: new Date().toLocaleDateString('pt-BR') + " " + new Date().toLocaleTimeString('pt-BR'),
                views: activeNewsId ? allNews.find(x=>x.id===activeNewsId).views || 0 : 0
            };

            if(activeNewsId) {
                db.ref('posts/' + activeNewsId).update(postData).then(() => {
                    toast("Not√≠cia atualizada!");
                    activeNewsId = null;
                    showSection('home');
                });
            } else {
                db.ref('posts').push(postData).then(() => {
                    toast("Not√≠cia publicada!");
                    showSection('home');
                });
            }
        }

        // --- INTERA√á√ïES ---
        function openNews(id) {
            activeNewsId = id;
            db.ref('posts/' + id + '/views').transaction(v => (v || 0) + 1);
            
            db.ref('posts/' + id).once('value', s => {
                const n = s.val();
                document.getElementById('modal-data').innerHTML = `
                    <span class="news-cat">${n.cat}</span>
                    <h1 style="font-size:38px; font-weight:800; line-height:1.1; margin: 15px 0;">${escapeHTML(n.title)}</h1>
                    <p style="font-size:20px; color:#666; margin-bottom:20px;">${escapeHTML(n.sub)}</p>
                    <div class="news-meta" style="margin-bottom:30px;">
                        <span>Por <strong>${n.author}</strong>, g1 Brookasil</span>
                        <span>‚Ä¢ ${n.date}</span>
                    </div>
                    <img src="${n.img}" style="width:100%; border-radius:8px;">
                    <div class="article-content">${escapeHTML(n.text).replace(/\n/g, '<br><br>')}</div>
                `;
                
                document.getElementById('view-likes').innerText = n.stats?.likes || 0;
                document.getElementById('view-unlikes').innerText = n.stats?.unlikes || 0;
                document.getElementById('view-reposts').innerText = n.stats?.reposts || 0;

                loadComments(id);
                document.getElementById('modal-view').style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
        }

        function interact(type) {
            if(!userSession) return toast("Fa√ßa login para interagir");
            db.ref(`posts/${activeNewsId}/stats/${type}`).transaction(c => (c || 0) + 1);
            db.ref(`posts/${activeNewsId}/stats/${type}`).once('value', s => {
                document.getElementById('view-' + type).innerText = s.val();
            });
        }

        function postComment() {
            if(!userSession) return toast("Fa√ßa login para comentar");
            const text = escapeHTML(document.getElementById('in-comment').value);
            if(!text) return;

            const comm = {
                user: userSession.name,
                pfp: userSession.pfp,
                text: text,
                timestamp: Date.now()
            };

            db.ref(`comments/${activeNewsId}`).push(comm).then(() => {
                document.getElementById('in-comment').value = "";
            });
        }

        function loadComments(id) {
            db.ref(`comments/${id}`).on('value', s => {
                const list = document.getElementById('comment-list');
                list.innerHTML = "";
                const data = s.val();
                if(data) {
                    Object.values(data).forEach(c => {
                        list.innerHTML += `
                            <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                                <img src="${c.pfp}" style="width:30px; height:30px; border-radius:50%;">
                                <div>
                                    <div style="font-weight:800; font-size:12px; color:var(--g1-red);">${c.user}</div>
                                    <div style="font-size:14px;">${c.text}</div>
                                </div>
                            </div>
                        `;
                    });
                }
            });
        }

        // --- UTILIT√ÅRIOS ---
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('relogio').innerText = now.toLocaleTimeString('pt-BR');
            
            if(now.getMonth() === 11 && now.getDate() === 31) {
                const target = new Date(now.getFullYear() + 1, 0, 1);
                const diff = target - now;
                const h = Math.floor(diff/3600000);
                const m = Math.floor((diff%3600000)/60000);
                const s = Math.floor((diff%60000)/1000);
                document.getElementById('countdown').innerText = `Contagem Regressiva: ${h}h ${m}m ${s}s`;
            }
        }

        function checkSpecialDate() {
            const now = new Date();
            const month = now.getMonth();
            const day = now.getDate();
            if (month === 11 && day >= 25) {
                document.getElementById('new-year-banner').style.display = 'block';
            }
        }

        function checkNewsSpecial(ts) {
            const d = new Date(ts);
            return d.getMonth() === 11 && d.getDate() >= 25;
        }

        function handleSearch() {
            const term = document.getElementById('global-search').value.toLowerCase();
            const filtered = allNews.filter(n => n.title.toLowerCase().includes(term));
            const feed = document.getElementById('news-feed');
            feed.innerHTML = term ? "<h3>Resultados da busca:</h3>" : "";
            // Re-render logic para busca... (simplificado)
            renderFeed(); 
        }

        function filterBy(cat) {
            currentFilter = cat;
            document.querySelectorAll('.filter-nav button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderFeed();
        }

        function canEdit(n) {
            if(!userSession) return false;
            if(userSession.role === 'Dono') return true;
            if(userSession.role === 'Jornalista' && n.author === userSession.name) return true;
            return false;
        }

        function canDelete(n) {
            if(!userSession) return false;
            if(userSession.role === 'Dono') return true;
            return false;
        }

        function deleteNews(id) {
            if(confirm("Deseja realmente apagar esta not√≠cia?")) {
                db.ref('posts/' + id).remove().then(() => toast("Apagado com sucesso"));
            }
        }

        function editNews(id) {
            activeNewsId = id;
            const n = allNews.find(x => x.id === id);
            document.getElementById('n-title').value = n.title;
            document.getElementById('n-sub').value = n.sub;
            document.getElementById('n-cat').value = n.cat;
            document.getElementById('n-img').value = n.img;
            document.getElementById('n-body').value = n.text;
            document.getElementById('editor-title').innerText = "Editar Not√≠cia";
            showSection('editor');
        }

        function togglePin(id, current) {
            db.ref('posts/' + id + '/pinned').set(!current);
        }

        function updateClima() {
            const c = document.getElementById('cfg-clima').value;
            if(c) db.ref('config/clima').set(c).then(() => toast("Clima atualizado!"));
        }

        function switchAuthMode() {
            isRegistering = !isRegistering;
            document.getElementById('auth-title').innerText = isRegistering ? "Cadastro" : "Login";
            document.getElementById('btn-auth-action').innerText = isRegistering ? "Criar Conta" : "Entrar";
            document.getElementById('btn-switch-auth').innerText = isRegistering ? "J√° tenho conta" : "N√£o tenho conta";
            document.getElementById('register-only').style.display = isRegistering ? 'block' : 'none';
        }

        function closeModal() {
            document.getElementById('modal-view').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function toggleMenu() {
            // Implementa√ß√£o de menu lateral se necess√°rio
            toast("Menu em constru√ß√£o...");
        }

        // --- INICIAR TUDO ---
        init();
    </script>
</body>
</html>
